<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Law Offices of Pritpal Singh — AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      /* Brandable theme tokens (swap to your exact hex) */
      --brand-navy:#0b2a4d;      /* Navy Blue */
      --brand-orange:#ff6a00;    /* Orange */
      --brand-navy-700:#0a2442;
      --brand-navy-50:#eef3f9;
      --ink:#0a0a0a;
      --muted:#5e6a7a;
      --bg:#ffffff;
      --surface:#f8f9fb;
      --ring:rgba(255,106,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    /* Full-page support layout (add class 'page-mode' on <body> to use as a dedicated page) */
    body.page-mode .support-shell{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    .support-header{display:none}
    body.page-mode .support-header{display:flex;align-items:center;gap:14px;padding:16px 20px;border-bottom:1px solid #e6eaf0;background:var(--brand-navy);color:#fff}
    .support-header .badge{background:rgba(255,255,255,.12);padding:4px 10px;border-radius:999px;font-size:12px}
    body.page-mode .chat-window{position:relative;max-width:1000px;margin:24px auto;padding:0 16px;height:calc(100vh - 100px)}
    /* Floating launcher for site-wide popup */
    .chat-launcher{position:fixed;right:18px;bottom:18px;background:var(--brand-orange);color:#fff;border:none;border-radius:999px;padding:14px 16px;font-weight:700;box-shadow:0 12px 30px rgba(0,0,0,.2);cursor:pointer}
    .chat-launcher:focus{outline:3px solid var(--ring)}
    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(7,16,28,.42);z-index:9999}
    .modal.open{display:grid}
    .modal-dialog{width:min(100%,720px);height:min(90vh,800px);background:#fff;border-radius:var(--radius);overflow:hidden;box-shadow:0 30px 80px rgba(3,14,26,.45)}
    /* Chat window */
    .chat-window{position:absolute;inset:0;display:grid;grid-template-rows:auto 1fr auto;background:#fff;border:1px solid #e6eaf0;border-radius:var(--radius)}
    .chat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--brand-navy);color:#fff}
    .chat-title{display:flex;align-items:center;gap:10px}
    .chat-title .dot{width:12px;height:12px;border-radius:50%;background:var(--brand-orange)}
    .chat-close{background:transparent;border:none;color:#fff;font-size:18px;cursor:pointer}
    .chat-messages{padding:16px;overflow:auto;background:var(--brand-navy-50)}
    .msg{display:grid;gap:6px;margin:0 0 14px}
    .msg.you .bubble{background:#fff;border:1px solid #dbe3ee}
    .msg.ai .bubble{background:#fff;border-left:4px solid var(--brand-orange);border:1px solid #e3e8f2}
    .bubble{padding:12px 14px;border-radius:12px}
    .role{font-size:12px;color:var(--muted)}
    .section-label{font-size:12px;text-transform:uppercase;letter-spacing:.05em;color:var(--muted)}
    .reasoning{background:#fafbfe;border:1px dashed #d9e2f2;padding:10px;border-radius:8px}
    .answer{padding-top:2px}
    .chat-input{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;border-top:1px solid #e6eaf0;background:#fff}
    .chat-input textarea{resize:none;min-height:48px;max-height:120px;padding:12px;border:1px solid #cfd9e6;border-radius:10px;font:inherit}
    .chat-input button{background:var(--brand-orange);color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .tools{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0}
    .pill{border:1px solid #dbe3ee;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .disclaimer{font-size:12px;color:#6b7788;margin:10px 0}
    /* Mobile full-screen modal feel */
    @media (max-width: 740px){
      .modal-dialog{width:100%;height:100%;border-radius:0}
      .chat-window{border:none;border-radius:0}
    }
  </style>
</head>
<body class="page-mode">
  <!-- Dedicated support page header (only visible in .page-mode) -->
  <div class="support-shell">
    <header class="support-header">
      <div style="font-weight:700">Law Offices of Pritpal Singh</div>
      <span class="badge">AI Legal Assistant</span>
    </header>

    <!-- PAGE MODE chat surface -->
    <main class="chat-window support" aria-live="polite" hidden></main>
  </div>

  <!-- Floating launcher + modal for site-wide use -->
  <button class="chat-launcher" id="openChat" aria-haspopup="dialog" aria-controls="chatModal">
   Live Chat
  </button>

  <div class="modal" id="chatModal" role="dialog" aria-modal="true" aria-label="AI legal assistant">
    <div class="modal-dialog">
      <div class="chat-window" id="chatWindow">
        <div class="chat-header">
          <div class="chat-title"><span class="dot" aria-hidden="true"></span> Law Offices of Pritpal Singh</div>
          <div>
            <button class="pill" id="langToggle" title="Switch language">Español</button>
            <button class="chat-close" id="closeChat" title="Close">✕</button>
          </div>
        </div>
        <div class="chat-messages" id="messages" tabindex="0"></div>
        <div class="chat-input">
          <textarea id="input" placeholder="Ask about California real estate law, consultations, billing…"></textarea>
          <button id="send">Send</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const OPENAI_API_KEY = "YOUR_OPENAI_API_KEY";
const MODEL_ID_PREFERRED = "gpt-5-mini";      // set this if your org has GPT-5 mini
const MODEL_ID_FALLBACK = "gpt-4.1-mini";     // safe fallback if 5-mini isn’t enabled yet

/* Firm facts (kept in one place for easy updates) */
const FIRM = {
  name: "Law Offices of Pritpal Singh",
  site: "https://pritsinghlaw.com",
  teamPrit: "https://pritsinghlaw.com/team/pritpal-singh",
  address: "509 13th St, Oakland, CA 94612",
  phone: "(510) 225-9220",
  email: "info@pritsinghlaw.com",
  payments: "https://pritsinghlaw.com/pay-my-bill",
  consult: {
    free15: "Free 15-minute consultation (phone or Zoom)",
    paid60: "Paid 60-minute consultation ($350, in person or Zoom)"
  }
};

/* Optional: Zapier webhooks (stubs) */
const ZAPIER = {
  scheduleConsultation: "",    // e.g., "https://hooks.zapier.com/hooks/catch/xxx/yyy"
  sendFollowupEmail: "",
  createStripeInvoice: ""
};

/* ===== SYSTEM PROMPT =====
   NOTE: We output a short “Reasoning summary” (high-level factors only),
   then the final concise answer. No hidden chain-of-thought.
*/
const SYSTEM_PROMPT = `
You are a helpful, policy-safe virtual assistant for the Law Offices of Pritpal Singh, a California real estate law firm.
PRIMARY GOAL: Provide **general legal information** (not legal advice) about California real estate topics and accurate firm information.
When users ask for actions (book consult, pay, send info), guide them and, when appropriate, call available tools.

OUTPUT STYLE (always):
1) "Reasoning summary" – 1–4 bullet points, high-level factors and next steps ONLY.
2) "Answer" – clear, concise (1–3 short paragraphs). Professional, friendly, empathetic.

DO NOT: provide legal advice, predict case outcomes, or disclose confidential info.
JURISDICTION: California law only. If outside CA or if specific advice is requested, add a gentle disclaimer and suggest a consult.

FIRM FACTS (verbatim):
- Firm: ${FIRM.name} (${FIRM.site})
- Lead attorney: Pritpal Singh, Esq. – CA Bar #350741 – ${FIRM.teamPrit}
- Office: ${FIRM.address}
- Contact: ${FIRM.phone} · ${FIRM.email}
- Consultations: ${FIRM.consult.free15}; ${FIRM.consult.paid60}
- Billing: Primary via LawPay at ${FIRM.payments}; Stripe available upon request.
- Never collect card numbers in chat. Direct users to the payment portal.

LANGUAGES: Offer to continue in Spanish, Hindi, Punjabi, Chinese, French, or German if it helps (note: "Hindi", not "Hindu").

BOOKING FLOW (if requested):
- Collect: full name, email, phone, preferred time windows/timezone, brief matter summary, and whether they prefer phone/Zoom/in-person.
- Then propose the next available slots and confirm. If tools are enabled, trigger "scheduleConsultation".

BILLING FLOW (if requested):
- Direct user to ${FIRM.payments} for LawPay.
- For Stripe on request, confirm email and send a secure payment link (tool: "createStripeInvoice").

UPSELL FLOW (optional):
- If matter is urgent or complex, suggest the paid 60-minute consult ($350).

SAFETY:
- No step-by-step internal reasoning. Provide only the public "Reasoning summary".
- If uncertain, say so and invite contact via phone/email or booking.

`;

/* ===== Minimal UI wiring ===== */
const d = (sel, root=document) => root.querySelector(sel);
const messagesEl = d('#messages');
const inputEl = d('#input');
const sendBtn = d('#send');
const modal = d('#chatModal');
const openBtn = d('#openChat');
const closeBtn = d('#closeChat');
const supportSurface = d('.support .chat-window');
const langToggle = d('#langToggle');

/* Page mode? If body has 'page-mode', show embedded window instead of modal */
if (document.body.classList.contains('page-mode')) {
  d('.support .chat-window').hidden = false;
} else {
  d('.support .chat-window')?.remove();
}

/* Modal open/close */
openBtn?.addEventListener('click', () => { modal.classList.add('open'); d('#messages').focus(); });
closeBtn?.addEventListener('click', () => modal.classList.remove('open'));

/* Language toggle (demo) */
let targetLocale = "en";
langToggle?.addEventListener('click', () => {
  targetLocale = targetLocale === "en" ? "es" : "en";
  langToggle.textContent = targetLocale === "en" ? "Español" : "English";
  addAI(`Reasoning summary:\n- Switching language preference to ${targetLocale === "en" ? "English" : "Spanish"} for clarity.\n\nAnswer:\nUnderstood. I can continue in ${targetLocale === "en" ? "English" : "Spanish"}. ¿Desea que continúe en este idioma?`);
});

/* Simple message rendering */
function addMsg(role, html){
  const wrap = document.createElement('div');
  wrap.className = `msg ${role}`;
  wrap.innerHTML = `<div class="role">${role === 'you' ? 'You' : 'Assistant'}</div><div class="bubble">${html}</div>`;
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
const esc = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]))

function addAI(text){
  // split optional "Reasoning summary:" and "Answer:" if present; otherwise, wrap nicely
  const hasSections = /Reasoning summary:/i.test(text) && /Answer:/i.test(text);
  let html = "";
  if(hasSections){
    const [_, rs, ans] = text.match(/Reasoning summary:\s*([\s\S]*?)\n\s*Answer:\s*([\s\S]*)/i) || ["","",""];
    html = `
      <div class="section-label">Reasoning summary</div>
      <div class="reasoning"><div>${esc(rs).replace(/\n/g,'<br>')}</div></div>
      <div class="section-label" style="margin-top:8px">Answer</div>
      <div class="answer">${esc(ans).replace(/\n/g,'<br>')}</div>
      <div class="disclaimer">This chat provides general information about California real estate law and our firm. It is not legal advice.</div>
    `;
  } else {
    html = `<div class="answer">${esc(text).replace(/\n/g,'<br>')}</div>
            <div class="disclaimer">This chat provides general information about California real estate law and our firm. It is not legal advice.</div>`;
  }
  addMsg('ai', html);
}

/* Conversation memory (small) */
const memory = [
  { role: "system", content: SYSTEM_PROMPT },
  { role: "assistant", content:
    `Reasoning summary:
- Welcome user and offer language options; explain scope (general info only).
- Invite a brief description of their CA real estate issue or ask if they want to book/pay.

Answer:
Hi! I’m the AI assistant for the Law Offices of Pritpal Singh. I can share general information on California real estate law, consultations, and billing. Would you like to continue in English, Español, हिंदी (Hindi), ਪੰਜਾਬੀ (Punjabi), 中文 (Chinese), Français, or Deutsch?` }
];

/* Send function using Chat Completions (straightforward; Responses API works too) */
async function chatCompletion(userText){
  const model = MODEL_ID_PREFERRED || MODEL_ID_FALLBACK;
  const payload = {
    model,
    messages: [...memory, { role: "user", content: userText }],
    temperature: 0.2
  };

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":`Bearer ${OPENAI_API_KEY}`
    },
    body: JSON.stringify(payload)
  });

  if(!res.ok){
    const err = await res.text();
    throw new Error(err || ("HTTP "+res.status));
  }
  const json = await res.json();
  const text = json?.choices?.[0]?.message?.content?.trim() || "(No response)";
  // store short transcript
  memory.push({ role:"user", content:userText });
  memory.push({ role:"assistant", content:text });
  return text;
}

/* Optional tool stubs (replace with your Zapier flows) */
async function toolScheduleConsultation(form){
  if(!ZAPIER.scheduleConsultation) return { ok:false, msg:"Scheduling integration not configured." };
  await fetch(ZAPIER.scheduleConsultation, { method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(form) });
  return { ok:true };
}
async function toolSendFollowupEmail(payload){
  if(!ZAPIER.sendFollowupEmail) return { ok:false };
  await fetch(ZAPIER.sendFollowupEmail,{method:"POST",headers:{ "Content-Type":"application/json" },body:JSON.stringify(payload)});
  return { ok:true };
}

/* Wire up UI */
sendBtn.addEventListener('click', send);
inputEl.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); } });

async function send(){
  const text = inputEl.value.trim();
  if(!text) return;
  addMsg('you', `<div class="answer">${esc(text)}</div>`);
  inputEl.value = "";
  const thinkingId = "thinking-"+Date.now();
  addMsg('ai', `<div id="${thinkingId}" class="answer">Thinking…</div>`);

  try{
    const out = await chatCompletion(text);
    const node = document.getElementById(thinkingId);
    if(node) node.parentElement.remove(); // remove "Thinking…" placeholder
    addAI(out);
  }catch(err){
    const node = document.getElementById(thinkingId);
    if(node) node.innerHTML = `Sorry—there was a problem reaching the model. (${esc(err.message)})`;
  }
}

/* If you want the embedded page version, add class 'page-mode' to <body>.
   Example: <body class="page-mode"> to render the full-page chat and hide the floating button.
*/
</script>
</body>
</html>
